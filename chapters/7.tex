% Chapter 7

\chapter{Design Decisions \& Implementation Details}

\label{ch:design}

%----------------------------------------------------------------------------------------

\section{Code Generation} \label{sec:design:codegen}

Code generation code is often something quite messy, with many conditionals and
a lot of \texttt{print} statements and string formatting. Such an approach is
both hard to read and hard to maintain. Additionally, it does not reflect the
structure of the generated code.

In the OpenSCAD backend implementation, \tangible{} uses an approach proposed by
Tomer Filiba \cite{filiba:2012}, which builds upon Python's context managers to
generate nested blocks of code.

\marginpar{Context Managers are Python constructs that create a runtime context
for a piece of code when used in combination with the \texttt{with} statement.
They provide enter- and exit-hooks that are invoked before and after executing
that code.}

There is a top level class called \texttt{Program} which exposes a
\texttt{statement} method and a \texttt{block} context manager. The class holds
a stack of blocks and a list of child blocks and statements. Each time a block
is entered (by using a \texttt{with}-statement), it is pushed to the stack and
appended to the list of children. When leaving the context manager, the block is
removed again from the stack.

The final code is generated by walking the list of children in the
\texttt{Program} instance recursively. This is also the point where
language-specific features can be implemented, for example indentation of a
block in Python or inserting curly braces in Java or C.

A special feature that was implemented in the code generation is the support for
predefined code snippets to be included in the generated output. This part of
the code is called the ``preamble''. Snippets can be inserted into the preamble
multiple times, but they're rendered only once. This has proven to be very
useful while implementing code generation for circle sectors (see section
\ref{sec:design:circlesectors}).

Right now all the described classes are contained in the OpenSCAD backend. By
generalizing the code, it would be possible to create a base class for all code
generation backends, with the possibility to configure the language-specific
details in a single subclass. This might be a good idea for a future version of
\tangible{}.

An extract from the actual code which decides how the AST is mapped to the
backend syntax is shown on the next page.

\vspace{.5\baselineskip}
\begin{pythoncode}
class OpenScadBackend(object):
    """Render AST to OpenSCAD source code."""

    def __init__(self, ast):
        self.ast = ast

    def generate(self):
        prgm = Program()
        BLOCK = prgm.block
        STMT = prgm.statement
        PRE = prgm.preamble
        SEP = prgm.emptyline

        def _generate(node):
            """Recursive code generating function."""

            istype = lambda t: node.__class__ is t

            # Handle lists
            if istype(list):
                for item in node:
                    _generate(item)

            # Simple statements
            elif istype(ast.Circle):
                STMT('circle({0})', node.radius)
            elif istype(ast.Rectangle):
                STMT('square([{0}, {1}])', node.width, node.height)

            # Blocks
            elif istype(ast.Union):
                with BLOCK('union()'):
                    _generate(node.items)

            # (...)

        _generate(self.ast)

        return prgm.render()
\end{pythoncode}

% todo preamble

%----------------------------------------------------------------------------------------

\newpage
\section{Circle Sectors in OpenSCAD}\label{sec:design:circlesectors}

TODO describe circle sectors.
